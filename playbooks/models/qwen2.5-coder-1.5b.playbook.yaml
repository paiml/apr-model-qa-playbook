# Qwen2.5-Coder-1.5B Model Qualification Playbook
# Model: Qwen/Qwen2.5-Coder-1.5B-Instruct
# Generated: 2026-01-30
# Updated: 2026-01-30 (GH-186 dtype fix verified)
# MQS Target: 85+

name: qwen2.5-coder-1.5b
version: "1.1.0"
description: "Qualification playbook for Qwen2.5-Coder-1.5B-Instruct"

model:
  hf_repo: "Qwen/Qwen2.5-Coder-1.5B-Instruct"
  formats:
    - gguf
    - safetensors
    - apr
  quantizations:
    - q4_k_m
    - q5_k_m
    - q8_0
  size_category: small

test_matrix:
  modalities:
    - run
    - chat
    - serve
  backends:
    - cpu
    - gpu
  scenario_count: 100
  seed: 42
  timeout_ms: 60000

gates:
  g1_model_loads: true
  g2_basic_inference: true
  g3_no_crashes: true
  g4_output_quality: true

oracles:
  - type: arithmetic
    config:
      tolerance: 0.01
  - type: garbage
    config:
      max_repetition_ratio: 0.3
      min_unique_chars: 10
  - type: code_syntax
    config:
      languages:
        - python
        - rust
        - javascript

failure_policy: stop_on_p0

property_tests:
  - name: arithmetic_correctness
    generator: "arithmetic(a: i32, b: i32, op: +|-|*)"
    oracle: "eval(a op b) == parse_int(output)"
    count: 50
  - name: code_syntax_validity
    generator: "code_prompt(lang: rust|python|js)"
    oracle: "is_valid_syntax(output, lang)"
    count: 50

# Differential Testing (GH-186, GH-188, PMAT-114, PMAT-192)
differential_tests:
  # APR format validation - dtype mapping verification (GH-186 root cause)
  format_validation:
    enabled: true
    checks:
      - dtype_mapping        # Q4K=12, Q5K=13, Q6K=14 match APR spec
      - tensor_alignment     # 64-byte alignment for SIMD
      - header_integrity     # Magic bytes and version
    gates:
      - F-APR-FORMAT-001     # Dtype byte matches APR v2 spec
      - F-APR-FORMAT-002     # Tensor alignment correct
      - F-APR-FORMAT-003     # Header magic/version valid

  # Rosetta tensor diff - detect layout mismatches
  tensor_diff:
    enabled: true
    filter: "embed,lm_head"
    gates:
      - F-ROSETTA-DIFF-001  # No transposed dimensions
      - F-ROSETTA-DIFF-002  # Shapes match after conversion

  # Rosetta inference comparison - token-by-token
  inference_compare:
    enabled: true
    prompt: "What is 2+2?"
    max_tokens: 10
    tolerance: 1e-5
    gates:
      - F-ROSETTA-INF-001   # Argmax match
      - F-ROSETTA-INF-002   # Logit diff within tolerance
      - F-ROSETTA-INF-003   # No PAD token flood (GH-186)

  # Rosetta fingerprint - statistical corruption detection (PMAT-201)
  fingerprint:
    enabled: true
    tensors: "all"
    stats: ["mean", "std", "min", "max", "checksum"]
    gates:
      - F-ROSETTA-FP-001    # No NaN/Inf in tensor stats
      - F-ROSETTA-FP-002    # Checksum matches reference

  # Rosetta validate-stats - anomaly detection (PMAT-202)
  validate_stats:
    enabled: true
    reference: "qwen2.5-coder-1.5b-reference.json"
    tolerance:
      layernorm: 0.001      # Strict for normalization
      embedding: 0.1        # Loose for embeddings
      attention: 0.01       # Medium for attention
    gates:
      - F-ROSETTA-STATS-001 # LayerNorm within tolerance
      - F-ROSETTA-STATS-002 # Embedding deviation acceptable
      - F-ROSETTA-STATS-005 # LayerNorm mean â‰ˆ 1.0 (not 0.0)
      - F-ROSETTA-STATS-006 # LayerNorm std > 0.0 (not zeroed)

# Profile CI Assertions (PMAT-192)
profile_ci:
  enabled: true
  warmup: 3
  measure: 10
  assertions:
    min_throughput: 5.0     # tok/s (CPU baseline)
    max_p99_ms: 500         # 500ms max p99 latency
    max_p50_ms: 200         # 200ms max p50 latency
  gates:
    - F-PROFILE-CI-001      # Throughput meets minimum
    - F-PROFILE-CI-002      # p99 within limit
    - F-PROFILE-CI-003      # p50 within limit

# Trace Payload Testing (APR-TRACE-001)
trace_payload:
  enabled: true
  prompt: "Write a Python function to add two numbers."
  gates:
    - F-TRACE-PAYLOAD-001   # No NaN/Inf in any layer
    - F-TRACE-PAYLOAD-002   # No garbage output
    - F-TRACE-PAYLOAD-003   # Layer outputs in range

metadata:
  author: "apr-qa-gen"
  architecture: "qwen2"
  expected_mqs: 85
  tags:
    - code
    - instruct
    - small
